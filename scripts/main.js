function Ball(t,e,i,s){PIXI.Sprite.call(this,s),this.x=t,this.y=e,this.width=2*i,this.height=2*i,this.r=i,this.maxr=30,this.m=i/100,this.vx=-2+4*Math.random(),this.vy=-2+4*Math.random(),this.remove=!1,this.anchor.x=.5,this.anchor.y=.5,this.alpha=.3+.7*Math.random(),this.scale.set(i/25),this.springs=[]}function keyboard(t){var e={};return e.code=t,e.isDown=!1,e.isUp=!0,e.press=void 0,e.release=void 0,e.downHandler=function(t){t.keyCode===e.code&&(e.isUp&&e.press&&e.press(),e.isDown=!0,e.isUp=!1),t.preventDefault()},e.upHandler=function(t){t.keyCode===e.code&&(e.isDown&&e.release&&e.release(),e.isDown=!1,e.isUp=!0),t.preventDefault()},window.addEventListener("keydown",e.downHandler.bind(e),!1),window.addEventListener("keyup",e.upHandler.bind(e),!1),e}function onReady(){Game.friction=!1,Game.gravity=Game.GRAVITY,renderer=PIXI.autoDetectRenderer(window.innerWidth,window.innerHeight,{backgroundColor:0}),myTree=new Quadtree({x:0,y:0,width:renderer.width,height:renderer.height},10,12),renderer.view.style.transform="translatez(0)",document.body.appendChild(renderer.view),renderer.view.style.position="absolute",stats=new Stats,document.body.appendChild(stats.domElement),stats.domElement.style.position="absolute",stats.domElement.style.top="0px",requestAnimationFrame(update),wabbitTexture=new PIXI.Texture.fromImage("images/bunnys.png"),ballTexture=new PIXI.Texture.fromImage("images/ball.png"),aimTexture=new PIXI.Texture.fromImage("images/aim.png"),absorbTexture=new PIXI.Texture.fromImage("images/absorbBall.png"),stickyTexture=new PIXI.Texture.fromImage("images/stickyBall.png"),rootContainer=new PIXI.Container,container=new PIXI.Container,rootContainer.addChild(container),Ui.init(),balltex=new PIXI.Texture(ballTexture.baseTexture,new PIXI.math.Rectangle(0,0,50,50)),aimtex=new PIXI.Texture(aimTexture.baseTexture,new PIXI.math.Rectangle(0,0,25,25)),absorbtex=new PIXI.Texture(absorbTexture.baseTexture,new PIXI.math.Rectangle(0,0,50,50)),stickytex=new PIXI.Texture(stickyTexture.baseTexture,new PIXI.math.Rectangle(0,0,50,50));for(var t=0;startballCount>t;t++){var e=Math.floor(Math.random()*renderer.width),i=Math.floor(Math.random()*renderer.height/2),s=new Ball(e,i,25,balltex);balls.push(s),container.addChild(s)}Input.init(),resize()}function resize(){Game.width=$(window).width(),Game.height=$(window).height();var t=$(window).width()/2-Game.width/2,e=$(window).height()/2-Game.height/2;renderer.view.style.left=$(window).width()/2-Game.width/2+"px",renderer.view.style.top=$(window).height()/2-Game.height/2+"px",stats.domElement.style.left=t+"px",stats.domElement.style.top=e+"px",Ui.update(),renderer.resize(Game.width,Game.height)}function update(){currentTime=(new Date).getTime(),delta=(currentTime-lastTime)/1e3,stats.begin(),myTree.clear(),isAdding&&"draw"==Game.currentCursor&&addBalls(),isAdding&&"absorb"==Game.currentCursor&&addAbsorbBalls(),isAdding&&"sticky"==Game.currentCursor&&addStickyBalls(),isAdding&&"throw"==Game.currentCursor&&Game.preThrowBall(),isAdding||"throw"!=Game.currentCursor||Game.throwBall();for(var t=0;t<balls.length;t++){var e=balls[t];myTree.insert(e);for(var i=myTree.retrieve(e),s=0;s<i.length;s++)checkCollision(i[s],e);isAdding&&"repel"==Game.currentCursor&&e.repel(),isAdding&&"attract"==Game.currentCursor&&e.attract(),isAdding&&"vacuum"==Game.currentCursor&&e.vacuum(),e.remove&&(container.removeChild(e),balls.splice(t,1),count--,Ui.counter.text=count+" Balls"),isAdding&&"split"==Game.currentCursor&&e.split(),e.update()}renderer.render(rootContainer),requestAnimationFrame(update),stats.end(),lastTime=currentTime}function dotproduct(t,e){for(var i=0,s=Math.min(t.length,e.length),r=0;s>r;r++)i+=t[r]*e[r];return i}!function(t,e){function i(t,e,i,s){this.max_objects=e||10,this.max_levels=i||4,this.level=s||0,this.bounds=t,this.objects=[],this.nodes=[]}i.prototype.split=function(){var t=this.level+1,s=e.round(this.bounds.width/2),r=e.round(this.bounds.height/2),n=e.round(this.bounds.x),o=e.round(this.bounds.y);this.nodes[0]=new i({x:n+s,y:o,width:s,height:r},this.max_objects,this.max_levels,t),this.nodes[1]=new i({x:n,y:o,width:s,height:r},this.max_objects,this.max_levels,t),this.nodes[2]=new i({x:n,y:o+r,width:s,height:r},this.max_objects,this.max_levels,t),this.nodes[3]=new i({x:n+s,y:o+r,width:s,height:r},this.max_objects,this.max_levels,t)},i.prototype.getIndex=function(t){var e=-1,i=this.bounds.x+this.bounds.width/2,s=this.bounds.y+this.bounds.height/2,r=t.y<s&&t.y+t.height<s,n=t.y>s;return t.x<i&&t.x+t.width<i?r?e=1:n&&(e=2):t.x>i&&(r?e=0:n&&(e=3)),e},i.prototype.insert=function(t){var e,i=0;if("undefined"!=typeof this.nodes[0]&&(e=this.getIndex(t),-1!==e))return void this.nodes[e].insert(t);if(this.objects.push(t),this.objects.length>this.max_objects&&this.level<this.max_levels)for("undefined"==typeof this.nodes[0]&&this.split();i<this.objects.length;)e=this.getIndex(this.objects[i]),-1!==e?this.nodes[e].insert(this.objects.splice(i,1)[0]):i+=1},i.prototype.retrieve=function(t){var e=this.getIndex(t),i=this.objects;if("undefined"!=typeof this.nodes[0])if(-1!==e)i=i.concat(this.nodes[e].retrieve(t));else for(var s=0;s<this.nodes.length;s+=1)i=i.concat(this.nodes[s].retrieve(t));return i},i.prototype.clear=function(){this.objects=[];for(var t=0;t<this.nodes.length;t+=1)"undefined"!=typeof this.nodes[t]&&this.nodes[t].clear();this.nodes=[]},t.Quadtree=i}(window,Math);var Stats=function(){var t=Date.now(),e=t,i=0,s=1/0,r=0,n=0,o=1/0,a=0,l=0,h=0,d=document.createElement("div");d.id="stats",d.addEventListener("mousedown",function(t){t.preventDefault(),f(++h%2)},!1),d.style.cssText="width:80px;opacity:0.9;cursor:pointer";var c=document.createElement("div");c.id="fps",c.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",d.appendChild(c);var u=document.createElement("div");u.id="fpsText",u.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",u.innerHTML="FPS",c.appendChild(u);var p=document.createElement("div");for(p.id="fpsGraph",p.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",c.appendChild(p);74>p.children.length;){var m=document.createElement("span");m.style.cssText="width:1px;height:30px;float:left;background-color:#113",p.appendChild(m)}var x=document.createElement("div");x.id="ms",x.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",d.appendChild(x);var y=document.createElement("div");y.id="msText",y.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",y.innerHTML="MS",x.appendChild(y);var v=document.createElement("div");for(v.id="msGraph",v.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",x.appendChild(v);74>v.children.length;)m=document.createElement("span"),m.style.cssText="width:1px;height:30px;float:left;background-color:#131",v.appendChild(m);var f=function(t){switch(h=t){case 0:c.style.display="block",x.style.display="none";break;case 1:c.style.display="none",x.style.display="block"}};return{REVISION:11,domElement:d,setMode:f,begin:function(){t=Date.now()},end:function(){var h=Date.now();i=h-t,s=Math.min(s,i),r=Math.max(r,i),y.textContent=i+" MS ("+s+"-"+r+")";var d=Math.min(30,30-30*(i/200));return v.appendChild(v.firstChild).style.height=d+"px",l++,h>e+1e3&&(n=Math.round(1e3*l/(h-e)),o=Math.min(o,n),a=Math.max(a,n),u.textContent=n+" FPS ("+o+"-"+a+")",d=Math.min(30,30-30*(n/100)),p.appendChild(p.firstChild).style.height=d+"px",e=h,l=0),h},update:function(){t=this.end()}}};Ball.prototype=new PIXI.Sprite,Ball.prototype.cunstructor=Ball,Ball.prototype.update=function(){var t=Game.wallDamping;this.position.x+=this.vx*delta,this.position.y+=this.vy*delta,this.vy+=Game.gravity*delta,this.applyFriction(),this.applySprings(),this.position.x+this.r>Game.width?(this.vx*=t,this.position.x=Game.width-this.r):this.position.x-this.r<0&&(this.vx*=t,this.position.x=0+this.r),this.position.y+this.r>Game.height?(this.vy*=t,this.position.y=Game.height-this.r):this.position.y-this.r<0&&(this.vy*=t,this.position.y=0+this.r),this.r<.6&&(this.remove=!0)},Ball.prototype.applyFriction=function(){if(Game.friction)var t=.995;else var t=.9997;this.vx*=t,this.vy*=t},Ball.prototype.repel=function(){var t=300,e=currentMousePos.x-this.x,i=currentMousePos.y-this.y,s=Math.sqrt(e*e+i*i);350>s&&(this.vx-=t*e/(s*s),this.vy-=t*i/(s*s))},Ball.prototype.attract=function(){var t=300,e=currentMousePos.x-this.x,i=currentMousePos.y-this.y,s=Math.sqrt(e*e+i*i);this.vx+=t*e/(s*s),this.vy+=t*i/(s*s)},Ball.prototype.vacuum=function(){var t=600,e=currentMousePos.x-this.x,i=currentMousePos.y-this.y,s=Math.sqrt(e*e+i*i);this.vx+=t*e/(s*s),this.vy+=t*i/(s*s);var r=Math.sqrt(e*e+i*i);10>r&&(this.remove=!0)},Ball.prototype.split=function(){var t=this.position.x-currentMousePos.x,e=this.position.y-currentMousePos.y,i=Math.sqrt(t*t+e*e);if(i<this.r){var s=new Ball(this.position.x,this.position.y,this.r/2,balltex);s.vx=this.vx,s.vy=this.vy,balls.push(s),container.addChild(s);var s=new Ball(this.position.x,this.position.y,this.r/2,balltex);s.vx=this.vx,s.vy=-this.vy,balls.push(s),container.addChild(s),count+=2,this.remove=!0}},Ball.prototype.squish=function(t){},Ball.prototype.absorb=function(t){this.r<this.maxr&&(this.r+=t.r,this.scale.set(this.r/25),t.remove=!0)},Ball.prototype.stick=function(t){this.springs.push(t)},Ball.prototype.applySprings=function(){for(var t=0;t<this.springs.length;t++){var e=this.springs[t],i=this;i.addChild(e)}},Ball.prototype.moveToward=function(t){var e=t.x-this.x,i=t.y-this.y,s=Math.sqrt(e*e+i*i),r=this.r+t.r;s>r&&(this.vx+=e/s*s,this.vy+=i/s*s)};var Input={};Input.init=function(){$(renderer.view).mousedown(function(t){currentMousePos.lastx=t.pageX,currentMousePos.lasty=t.pageY,isAdding=!0}),$(renderer.view).mouseup(function(t){isAdding=!1,Ui.update()}),$(renderer.view).mousemove(function(t){currentMousePos.x=t.pageX,currentMousePos.y=t.pageY});var t=keyboard(32);t.press=function(){};var e=0,i=["draw","repel","attract","throw","split","vacuum","absorb","sticky"];t.release=function(){e++,e%=8,Game.currentCursor=i[e],Game.activeBall=void 0,Ui.update()};var s=keyboard(71);s.press=function(){Game.gravity=Game.gravity>0?0:Game.GRAVITY},s.release=function(){Ui.update()};var r=keyboard(70);r.press=function(){Game.friction=!Game.friction},r.release=function(){Ui.update()}};var Ui={};Ui.init=function(){var t={font:"15px Helvetica",fill:"#fff",align:"center",stroke:"#fff",strokeThickness:0};count=startballCount,this.counter=new PIXI.Text(count+" Balls",t),rootContainer.addChild(this.counter),this.cursor=new PIXI.Text("[  ] "+Game.currentCursor,t),rootContainer.addChild(this.cursor),this.gravity=new PIXI.Text("[g] "+Game.gravity,t),rootContainer.addChild(this.gravity),this.friction=new PIXI.Text("[f] "+Game.friction,t),rootContainer.addChild(this.friction)},Ui.update=function(){this.counter.position.x=4,this.counter.position.y=50,this.counter.text=count+" Balls",this.cursor.position.x=4,this.cursor.position.y=70,this.cursor.text="[  ] "+Game.currentCursor,this.gravity.position.x=4,this.gravity.position.y=90,this.gravity.text="[g] "+Game.gravity,this.friction.position.x=4,this.friction.position.y=110,this.friction.text="[f] "+Game.friction},$(document).ready(onReady),$(window).resize(resize),window.onorientationchange=resize;var Game={FRICTION:1,currentCursor:"draw",GRAVITY:10,width:800,height:600,wallDamping:-.75,throwTime:0},balls=[],startballCount=2,isAdding=!1,count=0,container,uiContainer,lastTime=(new Date).getTime(),currentTime=0,delta=0,currentMousePos={x:-1,y:-1,lastx:-1,lasty:-1},amount=1,myTree,checkCollision=function(t,e){var i=t.x-e.x,s=t.y-e.y,r=Math.sqrt(i*i+s*s),n=t.r+e.r;if(n>=r){collide(t,e,r,n);var o=t.type,a=e.type;o!==a&&(("absorb"==o||"absorb"==a)&&absorb(t,e),("sticky"==o||"sticky"==a)&&stick(t,e))}},collide=function(t,e,i,s){if(0!=i&&!("sticky"==t.type&&void 0==e.type||"sticky"==e.type&&void 0==t.type)){var r=[(t.x-e.x)/i,(t.y-e.y)/i],n=[-r[1],r[0]],o=s-i;Math.random()>.5?(t.position.x+=r[0]*o,t.position.y+=r[1]*o):(e.position.x-=r[0]*o,e.position.y-=r[1]*o);var a=dotproduct(r,[t.vx,t.vy]),l=dotproduct(r,[e.vx,e.vy]),h=dotproduct(n,[t.vx,t.vy]),d=dotproduct(n,[e.vx,e.vy]),c=(a*(t.m-e.m)+2*e.m*l)/(e.m+t.m),u=(l*(e.m-t.m)+2*t.m*a)/(e.m+t.m),p=[c*r[0],c*r[1]],m=[u*r[0],u*r[1]],x=[h*n[0],h*n[1]],y=[d*n[0],d*n[1]],v=[p[0]+x[0],p[1]+x[1]],f=[m[0]+y[0],m[1]+y[1]],g=Game.FRICTION;t.vx=v[0]*g,t.vy=v[1]*g,e.vx=f[0]*g,e.vy=f[1]*g}},addBalls=function(){if(2e4>count)for(var t=0;amount>t;t++){var e=new Ball(currentMousePos.x,currentMousePos.y,2+4*Math.random(),balltex);balls.push(e),container.addChild(e),count++}Ui.counter.text=count+" Balls"},addAbsorbBalls=function(){for(var t=0;amount>t;t++){var e=new Ball(currentMousePos.x,currentMousePos.y,.5+1*Math.random(),absorbtex);e.type="absorb",balls.push(e),container.addChild(e),count++}Ui.counter.text=count+" Balls"},addStickyBalls=function(){for(var t=0;2>t;t++){var e=new Ball(currentMousePos.x,currentMousePos.y,.5+2*Math.random(),stickytex);e.type="sticky",balls.push(e),container.addChild(e),count++}Ui.counter.text=count+" Balls"},absorb=function(t,e){"images/absorbBall.png"==t._texture.baseTexture.imageUrl?e.absorb(t):t.absorb(e)},stick=function(t,e){"images/stickyBall.png"==t._texture.baseTexture.imageUrl?e.stick(t):t.stick(e)};Game.preThrowBall=function(){this.activeBall||(this.activeBall=new Ball(currentMousePos.x,currentMousePos.y,25,balltex),balls.push(this.activeBall),container.addChild(this.activeBall),count++,Ui.counter.text=count+" Balls"),this.graphics||(this.graphics=new Ball(currentMousePos.lastx,currentMousePos.lasty,8,aimtex),this.graphics.alpha=1,container.addChild(this.graphics)),this.activeBall.position.x=currentMousePos.x,this.activeBall.position.y=currentMousePos.y},Game.throwBall=function(){this.activeBall&&(this.activeBall.vx=-2*(currentMousePos.x-currentMousePos.lastx),this.activeBall.vy=-2*(currentMousePos.y-currentMousePos.lasty),delete this.activeBall,container.removeChild(this.graphics),delete this.graphics)};